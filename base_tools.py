import toml
import importlib.metadata
from pathlib import Path
from fastmcp.server.dependencies import get_access_token
from mcp.types import Icon


def get_jameson_icon() -> Icon:
    return Icon(
        # Bottle
        src="data:image/svg+xml;base64,PHN2ZyBpZD0iZmlfMjMwOTQzOSIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTI4IDEyOCIgaGVpZ2h0PSI1MTIiIHZpZXdCb3g9IjAgMCAxMjggMTI4IiB3aWR0aD0iNTEyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48bGluZWFyR3JhZGllbnQgaWQ9ImxnMSI+PHN0b3Agb2Zmc2V0PSIuMDM5OSIgc3RvcC1jb2xvcj0iI2ZjOWY0YiI+PC9zdG9wPjxzdG9wIG9mZnNldD0iLjgwOTQiIHN0b3AtY29sb3I9IiNmNDdlM2UiPjwvc3RvcD48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMV8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTMxLjg3NiIgeDI9IjE3NS4yMDkiIHhsaW5rOmhyZWY9IiNsZzEiIHkxPSI3Ny41NDMiIHkyPSI3Ny4yMSI+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzJfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjEyMS40MzciIHgyPSIxMTAuNDExIiB4bGluazpocmVmPSIjbGcxIiB5MT0iNDIuNTUxIiB5Mj0iNTAuNTciPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IGlkPSJsZzIiPjxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iIzU4NTk1YiI+PC9zdG9wPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzQxNDA0MiI+PC9zdG9wPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8zXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSI0LjU2NSIgeDI9IjIwLjgxNSIgeGxpbms6aHJlZj0iI2xnMiIgeTE9IjYyLjc2IiB5Mj0iNjMuMDEiPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF80XyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSI0NSIgeDI9Ijg1IiB4bGluazpocmVmPSIjbGcyIiB5MT0iMTEzIiB5Mj0iMTEzIj48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfNV8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTQuNjU3IiB4Mj0iMzcuOTA3IiB4bGluazpocmVmPSIjbGcyIiB5MT0iMjQuNzI1IiB5Mj0iMjAuNzI1Ij48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfNl8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iODguNTE3IiB4Mj0iMTAwLjc2NyIgeGxpbms6aHJlZj0iI2xnMiIgeTE9IjI4LjYyOSIgeTI9IjMwLjI1NCI+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzdfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjM2Ljk5OSIgeDI9IjkxIiB5MT0iNjMuNDk5IiB5Mj0iNjMuNDk5Ij48c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiNmZmQ2YTQiPjwvc3RvcD48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiNmZmJiNzYiPjwvc3RvcD48L2xpbmVhckdyYWRpZW50PjxnPjxwYXRoIGQ9Im03OSAzOGMtMi4zMDUtMS4yMTgtNC4xNzYtNS41MjctNS04aC0xMC0xMGMtLjgyNCAyLjQ3My0yLjY5NSA2Ljc4Mi01IDgtMTUgMTAtMjIgNy0yMiAxOWw1IDY0Yy4xNTEgMi42NDYgMi4zNDkgNSA1IDVoMjcgMjdjMi42NTEgMCA0Ljg0OS0yLjM1NCA1LTVsNS02NGMwLTEyLTctOS0yMi0xOXoiIGZpbGw9InVybCgjU1ZHSURfMV8pIj48L3BhdGg+PHBhdGggZD0ibTc3IDQyaC0yNmMtMTIuOTczIDguOTU4LTE5IDYuMjUtMTkgMTdsNCA1N2MwIDMgMi43MDcgNSA1IDVoMjMgMjNjMi4yOTMgMCA1LTIgNS01bDQtNTdjMC0xMC43NS02LjAyNy04LjA0Mi0xOS0xN3oiIGZpbGw9InVybCgjU1ZHSURfMl8pIj48L3BhdGg+PHBhdGggZD0ibTg5LjAzNSA1N2MtMTAuNTM2LTcuMy0yNS4wMTMtNy4wMDItMjUuMDM1LTctLjAyMi0uMDAyLTE0LjUwMS0uMy0yNS4wMzcgNy0uNTU3LjM4Ni0uOTk4IDEuMzA1LS45NjMgMmwuOTYzIDE2Yy4wNTQgMS4wNjIuODAzIDIgMS44MjcgMmgyMy4yMDguMDAyIDIzLjIwOGMxLjAyNCAwIDEuNzczLS45MzggMS44MjctMmwuOTYzLTE2Yy4wMzUtLjY5NS0uNDA2LTEuNjE0LS45NjMtMnoiIGZpbGw9InVybCgjU1ZHSURfM18pIj48L3BhdGg+PHBhdGggZD0ibTgzLjUyMyAxMTZoLTM3LjA0NmMtLjgxNiAwLTEuNDc3LS42NjEtMS40NzctMS40Nzd2LTMuMDQ2YzAtLjgxNi42NjEtMS40NzcgMS40NzctMS40NzdoMzcuMDQ2Yy44MTYgMCAxLjQ3Ny42NjEgMS40NzcgMS40Nzd2My4wNDZjMCAuODE2LS42NjEgMS40NzctMS40NzcgMS40Nzd6IiBmaWxsPSJ1cmwoI1NWR0lEXzRfKSI+PC9wYXRoPjxnPjxwYXRoIGQ9Im03NCAzMGgtMjBjLTEuMTA1IDAtMi0uODk1LTItMnYtMjFjMC0yLjc2MSAyLjIzOS01IDUtNWgxNGMyLjc2MSAwIDUgMi4yMzkgNSA1djIxYzAgMS4xMDUtLjg5NSAyLTIgMnoiIGZpbGw9InVybCgjU1ZHSURfNV8pIj48L3BhdGg+PHBhdGggZD0ibTc0IDMwaC0yMGMtMS4xMDUgMC0yLS44OTUtMi0ydi03aDI0djdjMCAxLjEwNS0uODk1IDItMiAyeiIgZmlsbD0idXJsKCNTVkdJRF82XykiPjwvcGF0aD48L2c+PGc+PHBhdGggZD0ibTg3LjIwOCA3OGgtNDYuNDE4Yy0xLjUwMSAwLTIuNzQyLTEuMjk2LTIuODI2LTIuOTQ5bC0uOTYyLTE1Ljk5MWMtLjA1NC0xLjA2MS41NDUtMi4yOTUgMS4zOTItMi44ODIgMTAuMzk3LTcuMjA0IDI0LjM1Ny03LjIwMSAyNS42MDYtNy4xNzcgMS4yNTctLjAyNyAxNS4yMDctLjAyNyAyNS42MDQgNy4xNzcuODQ3LjU4NiAxLjQ0NSAxLjgyMSAxLjM5MyAyLjg3M2wtLjk2NCAxNi4wMWMtLjA4MyAxLjY0My0xLjMyNCAyLjkzOS0yLjgyNSAyLjkzOXptLTIzLjQ4OS0yNy4wMDVjLTEuNzE4IDAtMTQuNjQyLjIxNS0yNC4xODcgNi44MjctLjI3MS4xODgtLjU1MS43NzktLjUzMyAxLjEyOGwuOTYyIDE1Ljk5Yy4wMjYuNTE1LjM1MSAxLjA2LjgyOSAxLjA2aDQ2LjQxOGMuNDc5IDAgLjgwMy0uNTQ1LjgyOC0xLjA1MWwuOTY0LTE2LjAwOWMuMDE3LS4zMzktLjI2My0uOTMtLjUzNC0xLjExOC0xMC4yMTUtNy4wNzctMjQuMjg5LTYuODI0LTI0LjQzOS02LjgyMmwtLjA1Ny4wMDEtLjA2Mi0uMDA1Yy0uMDA1IDAtLjA3LS4wMDEtLjE4OS0uMDAxeiIgZmlsbD0idXJsKCNTVkdJRF83XykiPjwvcGF0aD48L2c+PC9nPjwvc3ZnPg==",
        mimeType="image/svg+xml"
    )
def get_relativator_icon() -> Icon:
    return Icon(
        # Maya
        src="data:image/svg+xml;base64,PHN2ZyBpZD0iZmlfMTg3NDU0MDEiIHZpZXdCb3g9IjAgMCAxMDAwIDEwMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZGF0YS1uYW1lPSJMYXllciAxIj48cGF0aCBkPSJtNTUyLjUzIDY2MS4xOS01Mi41MyAyNjMuODEtNTIuNS0yNjMuNzhhMTI4LjE2IDEyOC4xNiAwIDAgMCAxMDUuMDYgMHoiIGZpbGw9IiMzNzQ3NGYiPjwvcGF0aD48cGF0aCBkPSJtMjYxLjE3IDc0Ny4xNCA1OS43MS00My44OC02MC41LTQ0LjQ4IDExOC44NC03Mi4zYTEyOC4yMSAxMjguMjEgMCAwIDAgNjguMjcgNzQuNzFsNTIuNTEgMjYzLjgxeiIgZmlsbD0iIzU0NmU3YSI+PC9wYXRoPjxwYXRoIGQ9Im03MzkuNjIgNjU4Ljc4LTYwLjUgNDQuNDggNTkuNzEgNDMuODgtMjM4LjgzIDE3Ny44NiA1Mi41LTI2My43OGExMjguMjIgMTI4LjIyIDAgMCAwIDY4LjI3LTc0LjcxbDExOC44NCA3Mi4zeiIgZmlsbD0iIzU0NmU3YSI+PC9wYXRoPjxwYXRoIGQ9Im02NjkuNTYgMTEzLjQxYTEuNjIgMS42MiAwIDAgMSAtLjEuMThxLTE2OS40OCA0Ni43OS0zMzguOTIgMGwtLjA5LS4xOGMtNS4yMi05LjY3IDEuNC0yMC45MSAxMy43LTIzLjI5YTgxMC44OCA4MTAuODggMCAwIDEgMzExLjcyIDBjMTIuMjkgMi4zOCAxOC45MSAxMy42MiAxMy42OSAyMy4yOXoiIGZpbGw9IiM0NTVhNjQiPjwvcGF0aD48cGF0aCBkPSJtNjI5LjIzIDI5Mi4xNmE1NjIuMjYgNTYyLjI2IDAgMCAxIC0yNTguNDYgMHE3Ljg4LTg5LjI4LTQwLjIzLTE3OC41NyAxNjkuNDYgNDYuNzkgMzM4LjkyIDAtNDguMSA4OS4zLTQwLjIzIDE3OC41N3oiIGZpbGw9IiM1NDZlN2EiPjwvcGF0aD48cGF0aCBkPSJtNjMwIDMzOWE1NjIgNTYyIDAgMCAxIC0yNjAgMCA3IDcgMCAwIDEgLTUuMjItOC4zOHExLjExLTUgMi0xMGEyODcuNTQgMjg3LjU0IDAgMCAwIDMuOTQtMjguNTEgNTYyLjI2IDU2Mi4yNiAwIDAgMCAyNTguNDYgMCAyODcuNTQgMjg3LjU0IDAgMCAwIDMuOTQgMjguNTFxLjkzIDUgMiAxMGE3IDcgMCAwIDEgLTUuMTIgOC4zOHoiIGZpbGw9IiM0NTVhNjQiPjwvcGF0aD48cGF0aCBkPSJtNzIyLjEzIDM2Ny40OGMwIDE5Ljc3LTM3LjI3IDM3LjI1LTk0LjMzIDQ3Ljg0LTM2LjE0IDYuNjgtODAuMjIgMTAuNjgtMTI3LjggMTAuNjhzLTkxLjY2LTQtMTI3LjgtMTAuNjhjLTU3LjA2LTEwLjU5LTk0LjMzLTI4LjA3LTk0LjMzLTQ3Ljg0IDAtMTkuMTMgMzQuOTQtMzYuMTQgODguOTUtNDYuODFxLS45MyA1LTIgMTBhNyA3IDAgMCAwIDUuMTggOC4zMyA1NjIgNTYyIDAgMCAwIDI2MCAwIDcgNyAwIDAgMCA1LjIxLTguMzhxLTEuMTEtNS0yLTEwYzUzLjk5IDEwLjcyIDg4LjkyIDI3LjczIDg4LjkyIDQ2Ljg2eiIgZmlsbD0iIzM3NDc0ZiI+PC9wYXRoPjxwYXRoIGQ9Im02MjcuOCA0MTUuMzJ2NjAuNzNoLTI1NS42di02MC43M2MzNi4xNCA2LjY4IDgwLjIyIDEwLjY4IDEyNy44IDEwLjY4czkxLjY2LTQgMTI3LjgtMTAuNjh6IiBmaWxsPSIjZmZhYjkxIj48L3BhdGg+PHBhdGggZD0ibTYyNy44IDU0NC42NXYtNjguNmMwIDMyLjgzLTI4LjYgNTkuNDUtNjMuODkgNTkuNDVzLTYzLjkxLTI2LjYyLTYzLjkxLTU5LjQ1YzAgMzIuODMtMjguNiA1OS40NS02My45IDU5LjQ1cy02My45LTI2LjYyLTYzLjktNTkuNDV2NjguNmExMjcuOCAxMjcuOCAwIDEgMCAyNTUuNiAweiIgZmlsbD0iI2ZmYWI5MSI+PC9wYXRoPjxnIGZpbGw9IiM2MTYxNjEiPjxwYXRoIGQ9Im01MDAgNDc2LjA1YzAgMzIuODMtMjguNiA1OS40NS02My45IDU5LjQ1cy02My45LTI2LjYyLTYzLjktNTkuNDV6Ij48L3BhdGg+PHBhdGggZD0ibTYyNy44IDQ3Ni4wNWMwIDMyLjgzLTI4LjYgNTkuNDUtNjMuODkgNTkuNDVzLTYzLjkxLTI2LjYyLTYzLjkxLTU5LjQ1eiI+PC9wYXRoPjwvZz48L3N2Zz4=",
        mimeType="image/svg+xml"
    )

def get_version_info() -> str:
    """Reads the version number from the pyproject.toml file."""
    pyproject_path = Path(__file__).parent / "pyproject.toml"
    version = "0.0.0"
    fastmcp_version = importlib.metadata.version("fastmcp")
    if pyproject_path.exists():
        pyproject_data = toml.load(pyproject_path)
        if "project" in pyproject_data and "version" in pyproject_data["project"]:
            version = pyproject_data["project"]["version"]
    return (
        f"just-mcp-oauth-proxy-example: v{version}\n"
        f"fastmcp: v{fastmcp_version}"
    )


async def get_azure_user_info() -> dict:
    """Returns information about the authenticated Azure user."""
    token = get_access_token()
    # The AzureProvider stores user data in token claims
    return {
        "azure_id": token.claims.get("sub"), # type: ignore
        "email": token.claims.get("email"), # type: ignore
        "name": token.claims.get("name"), # type: ignore
        "job_title": token.claims.get("job_title"), # type: ignore
        "office_location": token.claims.get("office_location") # type: ignore
    }